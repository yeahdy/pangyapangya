<!DOCTYPE HTML>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<html>
<head>
    <title>원데이클래스 | 상세보기</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <meta name="description" content="" />
    <meta name="keywords" content="" />
    <link rel="stylesheet" href="/css/main.css" />
    <link rel="icon" type="image/png"  href="/images/favicon.png"/>
    <style>
        .headerIcon{
            width: 40px;
            display: block;
            margin: auto;"
        }
        .icon.solid:before {
            font-weight: 100;
            content: none;
        }

        .spotlights h5{
            font-weight: bold;
            font-size: small;
        }

        .spotlights p{
            font-size: small;
        }

        /* 검색창 */
        .search {
            position: relative;
            text-align: center;
            width: 400px;
            margin: 0 auto;
        }
        input {
            width: 100%;
            border-radius: 20px;
            border: 1px solid #bbb;
            margin: 10px 0;
            padding: 10px 12px;
        }
        .fa-search {
            position: absolute;
            left: 90%;
            top: 35%;
            margin: 0;
        }
        form {
            margin: 0;
        }

        /* 탭 */
        p {
            margin: 0 0 20px;
            line-height: 1.5;}

        .main1 {
            min-width: 320px;
            max-width: 800px;
            padding: 0px 30px 30px 20px;
            margin-left: 2em;
            background: #ffffff;
        }

        section #content1{
            display: none;
            padding: 20px 0 0;
            border-top: 1px solid #ddd;}

        section #content2{
            display: none;
            padding: 20px 0 0;
            border-top: 1px solid #ddd;}

        /*라디오버튼 숨김*/

        input[type="radio" i] {
            display: none;
        }

        label {
            display: inline-block;
            margin: 0 0 -1px;
            padding: 15px 25px;
            font-weight: 600;
            text-align: center;
            color: #bbb;
            border: 1px solid transparent;}

        label:hover {
            color: #2e9cdf;
            cursor: pointer;}

        input[type="radio"]:checked + label:before {
            background-color: #F9A825;
            border-color: #F9A825;
            color: #fff;
            display: none;
        }
        input[type="radio"] + label:before {
            border-radius: 100%;
            display: none;
        }

        input[type="radio"] + label {
            text-decoration: none;
            cursor: pointer;
            display: inline-block;
            font-size: 1em;
            font-weight: 400;
            padding-left: 2.4em;
            padding-right: 2.4em;
            position: relative;
        }
        /*input 클릭시, label 스타일*/
        input:checked + label {
            color: #555;
            border: 0px solid #ddd;
            border-bottom: 3px solid #2e9cdf;
            border-top: 1px solid #ffffff;}

        #tab1:checked ~ #content1,
        #tab2:checked ~ #content2{
            display: block;}

        h2{
            text-align: center;
        }

        /* 신청하기 버튼 가운데 정렬 */
        ul.actions{
            justify-content: center;
        }

        #apply{
            border: 1px;
            width: 300px;
        }

        .summary{
            margin: 2em 2em 2em 2em;
            border: 1px;
        }

        #save{
            border-radius: 20px;
            margin: 10px;
        }

        /* 별점 */
        #star a{ text-decoration: none; color: gray; } #star a.on{ color: orange; }
        #star{
            margin-left: 0px;
            margin-top: 40px;
            margin-bottom: 10px;
        }


        #btn_write{
            margin-bottom: 10px;
        }

        .text1{
            border: none;
            background-color: white;
        }

        .chapter{
            height: 50px; margin-bottom: 13px;vertical-align: middle;
        }

        #tabtab{
            margin-left: 2em;
        }

    </style>
    <script src="https://code.jquery.com/jquery-1.10.2.js"></script>
</head>
<body class="is-preload" style="padding: 200px">

<!-- Header -->
<header id="header" th:include="/main/header::header_body">

</header>

<!-- Wrapper -->
<div class="wrapper" th:object="${class}">

    <!-- Main -->
    <section class="main left">

        <!-- Banner -->
        <section id="banner">
            <article data-position="bottom right">
                <div class="inner">
                    <img src="/images/bread1.jpg" alt="">
                </div>
            </article>
            <article data-position="top right">
                <div class="inner">
                    <img src="/images/bread2.jpg" alt="">
                </div>
            </article>
            <article data-position="right">
                <div class="inner">
                    <img src="/images/bread3.jpg" alt="">
                </div>
            </article>
            <article data-position="center">
                <div class="inner">
                    <img src="/images/bread4.jpg" alt="">
                </div>
            </article>
        </section>


        <div class="fields">
            <!-- Blurb -->
            <section id="tabtab">
                <strong>
                    <input name="title" type="text" th:field="*{shopName}"readonly style="background-color: white; border: 0px; width: 75%; font-size: 15px"/>
                </strong>
                <input name="title" type="text" th:field="*{title}"readonly style="background-color: white; border: 0px; width: 75%;"/>
            </section>

            <!--         TAB -->
            <div class="main1">
                <input id="tab1" type="radio" name="tabs" checked> <!--디폴트 메뉴-->
                <label for="tab1">상세 설명</label>


                <input id="tab2" type="radio" name="tabs">
                <label for="tab2">후기</label>


                <section id="content1">
                    <div class="chapter">
                        <div style="float: left; margin-top: 0.7em;">
                            이렇게 진행됩니다.
                        </div>
                        <div style="float:right; width: 80%; background-color: white;">
                            <textarea name="content" rows="6" style="height:250px " th:text="*{description}" readonly class="text1"></textarea>
                        </div>
                    </div>

                    <div class="chapter">
                        <div style="float: left; width: 20%; margin-top: 0.7em;">
                            가격
                        </div>
                        <div style="float:right; width: 80%; height: 20%; background-color: white;" >
                            <textarea name="content" rows="6" style="height:50px" th:text="*{classPrice}" readonly class="text1" >원</textarea>
                        </div>
                    </div>

                    <div class="chapter">
                        <div style="float: left; width: 20%; margin-top: 0.7em;">
                            모집기간
                        </div>
                        <div style="float:right; width: 80%; height: 20%; background-color: white;">
                            <textarea name="content" rows="6" style="height:50px " th:text="*{regDate}+' ~ '+ *{endDate}" readonly class="text1"></textarea>
                        </div>
                    </div>

                    <div style="height: 50px; margin-bottom: 13px;">
                        <div style="float: left; width: 20%; margin-top: 0.7em;">
                            인원 수
                        </div>
                        <div style="float:right; width: 80%; height: 20%; background-color: white;">
                            <textarea name="content" rows="6" style="height:50px " th:text="*{recruitment}" readonly class="text1">명</textarea>
                        </div>
                    </div>

                    <div class="chapter">
                        <div style="float: left; width: 20%; margin-top: 0.7em;">
                            위치
                        </div>
                    </div>
                    <p style="margin-top:-12px">
                        <em class="link">
                            <a href="javascript:void(0);" onclick="window.open('http://fiy.daum.net/fiy/map/CsGeneral.daum', '_blank', 'width=981, height=650')">
                                혹시 주소 결과가 잘못 나오는 경우에는 여기에 제보해주세요.
                            </a>
                        </em>
                    </p>
                    <div id="map" style="width:100%;height:350px;"></div>
                </section>

                <section id="content2">
                    <form method="post" action="/class/classDetail" id="registForm">

                        <div id="replywrite">
                            <div id="btn_write">
                                <!--                        <button type="submit" id="btn_toggle">리뷰 쓰기</button>-->
                                <a href="javascript:void(0)" class="register button primary small" style="width: 10%">댓글등록</a>
                            </div>
                        </div>

                        <!--                <a href="javascript:void(0)" class="register button primary small" style="width: 10%">댓글등록</a>-->

                        <div>
                            <div style="display: none" class="register-form">
                                <div>
                                    <!--                                    <span id="userid" style="float:left; margin-top: 1em;" >사용자 아이디</span>-->
                                    <div th:if="${session.sessionU != null}">
                                        <input type="text" id="sessionU" th:value="${session['sessionU']}" style="background-color: white" name="userId" />
                                    </div>
                                    <!--                                        <input type="text" name="replier" placeholder="Replier">-->
                                </div>
                                <div>
                                    <div id="star" > <!-- 부모 -->
                                        <a href="#" onclick="return false" value="1">★</a> <!-- 자식들-->
                                        <a href="#" onclick="return false" value="2">★</a>
                                        <a href="#" onclick="return false" value="3">★</a>
                                        <a href="#" onclick="return false" value="4">★</a>
                                        <a href="#" onclick="return false" value="5">★</a>
                                    </div>
                                </div>
                                <!--                        <div>-->
                                <!--                            <div class="files">-->
                                <!--                                <input id="reviewimg" name="reviewimg" type="file">-->
                                <!--                            </div>-->
                                <!--                        </div>-->
                                <div class="field">
                                    <input type="file" name="uploadFiles" multiple style="border: 0px">
                                </div>
                                <div class="field">
                                    <div class="uploadResult">
                                        <ul></ul>
                                    </div>
                                </div>
                                <div class="bigPictureWrapper">
                                    <div class="bigPicture"></div>
                                </div>
                                <div><textarea rows="6" name="reply" placeholder="Reply" style="resize: none"></textarea></div>
                                <div>
                                    <a href="javascript:void(0)" type="submit" id="save" class="finish button primary small" style="float: right">등록</a>
                                    <a href="javascript:void(0)" class="cancel button primary small" style="float: right; border-radius: 20px; margin: 10px;">취소</a>
                                </div>
                                <!--                        <ul class="actions special">-->
                                <!--                            <li><input type="submit" class="button" value="등록" /></li>-->
                                <!--                        </ul>-->
                            </div>
                            <ul class="replies" style="margin-top: 3em"></ul>
                        </div>
                    </form>
                    <div class="paging" style="text-align: center"></div>
                </section>
            </div>
        </div>
    </section>

    <!-- Sidebar -->
    <!-- 우측 결제하기 box -->
    <div id="apply">
        <div class="summary">
            <section>
                <h2>장소 및 일정</h2>
                <p>장소 : </p>
                <p>일정 : <span th:text="*{classDate}"></span></p>
                <ul class="actions">
                    <a id="goRead" th:href="*{bno}">신청하기</a>
                    <!--                    <li><a href="/class/classApply" class="button">신청하기</a></li>-->
                </ul>
            </section>
        </div>
    </div>
</div>
</div>
<p>

</p>
<!-- Footer -->
<footer id="footer" th:include="/main/footer::footer_body"></footer>

<!-- Scripts -->
<script src="/js/jquery.min.js"></script>
<script src="/js/jquery.dropotron.min.js"></script>
<script src="/js/browser.min.js"></script>
<script src="/js/breakpoints.min.js"></script>
<script src="/js/util.js"></script>
<script src="/js/main.js"></script>
<script src="/js/classreply.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script th:replace="/main/header::header_js"></script>
<script>

    // 세션값 확인
    if($('#sessionU').val() != null){
        console.log("session: " + $('#sessionU').val());
    }

    $('#star a').click(function(){
        $(this).parent().children("a").removeClass("on");
        $(this).addClass("on").prevAll("a").addClass("on");
        console.log($(this).attr("value")); });
</script>
<!--<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=dbbd6cafd6a9270f3ff84ad1d9873ab9"></script>-->
<!--<script>-->
<!--    $(function (){-->
<!--        $("#btn_toggle").click(function (){-->
<!--            $("#Toggle").toggle();-->
<!--        });-->
<!--    });-->
<!--</script>-->
<!--<script>-->
<!--    var mapContainer = document.getElementById('map'), // 지도를 표시할 div-->
<!--        mapOption = {-->
<!--            center: new kakao.maps.LatLng(37.500151, 127.035613), // 지도의 중심좌표-->
<!--            level: 3 // 지도의 확대 레벨-->
<!--        };-->

<!--    // 지도를 생성합니다-->
<!--    var map = new kakao.maps.Map(mapContainer, mapOption);-->

<!--    // 주소-좌표 변환 객체를 생성합니다-->
<!--    var geocoder = new kakao.maps.services.Geocoder();-->

<!--    // 주소로 좌표를 검색합니다-->
<!--    geocoder.addressSearch('서울 강남구 역삼동 736-6', function(result, status) {-->

<!--        // 정상적으로 검색이 완료됐으면-->
<!--        if (status === kakao.maps.services.Status.OK) {-->

<!--            var coords = new kakao.maps.LatLng(result[0].y, result[0].x);-->

<!--            // 결과값으로 받은 위치를 마커로 표시합니다-->
<!--            var marker = new kakao.maps.Marker({-->
<!--                map: map,-->
<!--                position: coords-->
<!--            });-->

<!--            // 인포윈도우로 장소에 대한 설명을 표시합니다-->
<!--            var infowindow = new kakao.maps.InfoWindow({-->
<!--                content: '<div style="width:150px;text-align:center;padding:6px 0;">우리회사</div>'-->
<!--            });-->
<!--            infowindow.open(map, marker);-->

<!--            // 지도의 중심을 결과값으로 받은 위치로 이동시킵니다-->
<!--            map.setCenter(coords);-->
<!--        }-->
<!--    });-->
<!--</script>-->

<script th:inline="javascript">
    let bno = [[${class.getBno()}]];
    let replyUL = $("ul.replies");
    let uploadResult = $(".uploadResult ul");
    let pageNum = 1;
    let userId = $('#sessionU').val();


    $(".bigPictureWrapper").on("click", function(){
        if(!check){return;}
        $(".bigPicture").animate({width: "0%", height: "0%"}, 1000);
        setTimeout(function(){
            check = false;
            $(".bigPictureWrapper").hide();
        }, 1000)
    })

    // 댓글 (쓰기 전) 등록 버튼 누르면 보이게하기
    $(".register").on("click", function(e){
        e.preventDefault();
        $(".register-form").show();
        $(this).hide();
    })

    // 댓글 등록 취소 버튼
    $(".cancel").on("click", function(e){
        e.preventDefault();
        $("textarea[name='reply']").val("");
        $(".register-form").hide();
        $(".register").show();
    })



    // $("a#goList").on("click", function(){
    //     location.href = "/class/list" + paging;
    // });

    function showReplyPage(replyCnt){
        let endNum = Math.ceil(pageNum / 10.0) * 10;
        let startNum = endNum - 9;
        let realEnd = Math.ceil(replyCnt / 10.0);
        let divTag = $(".paging");
        let str = "";

        if(endNum > realEnd){
            endNum = realEnd;
        }

        let prev = startNum != 1;
        let next = endNum * 10 < replyCnt;

        //917px 까지
        if(matchMedia("screen and (max-width:918px)").matches){
            if(pageNum > 1){
                str += "<a class='changePage' href='" + (pageNum - 1) + "'><code>&lt;</code></a>"
            }
            str += "<code>" + pageNum + "</code>";
            if(pageNum < realEnd){
                str += "<a class='changePage' href='" + (pageNum + 1) + "'><code>&gt;</code></a>"
            }

        }else{//918px 이상
            if(prev){
                str += "<a class='changePage' href='" + (startNum - 1) + "'><code>&lt;</code></a>"
            }
            for(let i=startNum; i<=endNum; i++){
                if(i == pageNum){
                    str += "<code>" + i + "</code>";
                    continue;
                }
                str += "<a class='changePage' href='" + i + "'><code>" + i + "</code></a>";
            }
            if(next){
                str += "<a class='changePage' href='" + (endNum + 1) + "'><code>&gt;</code></a>"
            }
        }
        divTag.html(str);
    }

    //이벤트 위임
    //작성된 HTML에는 이벤트 처리가 가능하지만,
    //DOM에서 새롭게 추가되는 HTML에는 이벤트가 반영되지 않는다.
    //따라서 미리 작성해놓은 HTML에 이벤트를 반영한 후,
    //해당 자식 태그를 선택하여 이벤트 위임을 진행해야 한다.
    $("div.paging").on("click", "a.changePage", function(e){
        e.preventDefault();
        pageNum = parseInt($(this).attr("href"));
        showList(pageNum);
    });

    function showList(page){

        console.log("들어와ㅏ라라ㅏ");

        classReplyService.getList({bno:bno, page:page || 1},
            function(replyCnt, list){
                if(list == null || list.length == 0){
                    replyUL.html("댓글이 없습니다.");
                    return;
                }
                let str = "";
                for(let i=0, len=list.length; i<len; i++){
                    str += "<li style='display: block' data-rno='" + list[i].rno + "'>"
                    str += "<strong>" + list[i].userId + "</strong>"
                    str += "<div>"
                    str += "<p class='reply" + list[i].rno +"'>" + list[i].reply + "</p>"
                    str += "<p><strong class='date'>" + classReplyService.displayTime(list[i].replyDate);

                    str += "</strong></p></div>"
                    str += "</li>"
                    str += "<div class='line'></div>"
                }
                replyUL.html(str);
                showReplyPage(replyCnt);
            }
        );
    }

    let check = false;

    $(".replies").on("click", "a.modify", function(e){
        e.preventDefault();
        if(check){alert("수정 중인 댓글이 있습니다."); return;}
        let rnoValue = $(this).attr("href");
        $("p.reply" + rnoValue).html("<textarea class='" + rnoValue + "'>" + $("p.reply" + rnoValue).text() + "</textarea>")
        $(this).hide();

        let arFinish = $(".finish");
        for(let i=0; i<arFinish.length; i++){
            if($(arFinish[i]).attr("href") == rnoValue){
                $(arFinish[i]).show();
                check = true;
                break;
            }
        }
    });

    // $(".replies").on("click", "a.finish", function(e){
    //     e.preventDefault();
    //
    //     let rnoValue = $(this).attr("href");
    //     let newReply = $("." + rnoValue).val();
    //
    //     if(newReply == ""){return;}
    //
    //     classReplyService.update({rno:rnoValue, reply:newReply},
    //         function(result){
    //             alert(result);
    //             check = false;
    //             showList(pageNum);
    //         }
    //     )
    // })

    // 댓글 (다 쓴 후) 등록 버튼
    $(".finish").on("click", function(e){
        e.preventDefault();
        let reply = $("textarea[name='reply']").val();

        console.log("들어옴ㅁㅁㅁㅁㅁ");
        // if(!userId || !content){return;}

        classReplyService.add({bno:bno, reply:reply},
            function(result){
                alert(result);

                console.log(result);

                $("input[name='userId']").val(userId);
                $("textarea[name='reply']").val("");
                $(".register-form").hide();
                $(".register").show();
                showList(pageNum);
            }
        )

    });

    // let check = false;
    // function showImage(fileCallPath){
    //     if(check) {return;}
    //     $(".bigPictureWrapper").css("display", "flex").show();
    //     $(".bigPicture").html("<img src='/uploadcr/display?fileName=" + encodeURIComponent(fileCallPath) + "'>")
    //         .animate({width:"100%", height:"100%"}, 1000);
    //     check = true;
    // }


    $(document).ready(function(){
        let regex = new RegExp("(.*?)\.(exe|sh|zip|alz)$");
        let maxSize = 5242880;// 5MB
        let inputFile = $(".uploadDiv input");
        let uploadResult = $(".uploadResult ul");

        //form태그에 input hidden 생성 실습
        //서버 쪽으로 전달할 첨부파일의 데이터를 input type hidden으로 추가하기
        //추가된 li태그를 모두 가져와서 data속성을 통해 알맞는 값을 설정한다.
        //form.append("추가할 HTML") : HTML 추가
        //submit을 눌렀을 때 click 이벤트를 발생하고, 기존 submit이벤트는 막아줘야 한다.
        //input태그가 모두 추가된 후 submit()해준다.

        $("input[type='submit']").on("click", function(e){
            e.preventDefault();
            let form = $("form#registForm");
            let str = "";
            $(".uploadResult ul li").each(function(i, obj){
                str += "<input type='hidden' name='attachList[" + i + "].fileName' value='" + $(obj).data('name') + "'>"
                str += "<input type='hidden' name='attachList[" + i + "].uuid' value='" + $(obj).data('uuid') + "'>"
                str += "<input type='hidden' name='attachList[" + i + "].uploadPath' value='" + $(obj).data('path') + "'>"
                str += "<input type='hidden' name='attachList[" + i + "].image' value='" + $(obj).data('type') + "'>"
            });
            form.append(str).submit();
        })

        function showUploadFile(uploadFiles){
            let str = "";
            $(uploadFiles).each(function(i, obj){
                if(!obj.image){
                    let fileCallPath = encodeURIComponent(obj.uploadPath + "/" + obj.fileName);

                    str += "<li data-path='" + obj.uploadPath + "' data-uuid='" + obj.uuid + "' data-name='" + obj.fileName.substring(obj.fileName.indexOf("_") + 1) + "' data-type='" + obj.image +"'>";
                    str += "<div>";
                    str += "<a href='/uploadcr/download?fileName=" + fileCallPath + "'>";
                    str += "<img src='/images/attach.png' width='100px'>" + obj.fileName.substring(obj.fileName.indexOf("_") + 1);
                    str += "</a>"
                    str += "<span data-file='" + fileCallPath + "' data-type='file'>x</span>";
                    str += "</div>";
                    str += "</li>";
                }else{
                    let fileCallPath = encodeURIComponent(obj.uploadPath + "/s_" + obj.fileName);
                    let originPath = encodeURIComponent(obj.uploadPath + "/" + obj.fileName);

                    str += "<li data-path='" + obj.uploadPath + "' data-uuid='" + obj.uuid + "' data-name='" + obj.fileName.substring(obj.fileName.indexOf("_") + 1) + "' data-type='" + obj.image +"'>";
                    str += "<div>";
                    str += "<a href=\"javascript:showImage(\'" + originPath + "\')\">";
                    str += "<img src='/uploadcr/display?fileName=" + fileCallPath + "'>" + obj.fileName.substring(obj.fileName.indexOf("_") + 1);
                    str += "</a>";
                    str += "<span data-file='" + fileCallPath + "' data-type='image'>x</span>";
                    str += "</div>";
                    str += "</li>";
                }
            });
            uploadResult.append(str);
        }

        // $(".uploadResult").on("click", "span", function(){
        //     let targetFile = $(this).data("file");
        //     let type = $(this).data("type");
        //     let li = $(this).parents("li");
        //
        //     $.ajax({
        //         url: "/uploadcr/deleteFile",
        //         type: "POST",
        //         data: {fileName:targetFile, type:type},
        //         dataType: "text",
        //         success: function(result){
        //             alert(result);
        //             li.remove();
        //         }
        //     });
        //
        // });

        //확장자 별 업로드 제한, 특정 크기 이상의 파일은 업로드 제한
        function checkExtension(fileName, fileSize){
            if(regex.test(fileName)){
                alert("업로드 할 수 없는 파일의 형식입니다.");
                return false;
            }
            if(fileSize >= maxSize){
                alert("파일 사이즈 초과");
                return false;
            }
            return true;
        }

        $("input[type='file']").change(function(){
            let formData = new FormData();
            let inputFile = $("input[name='uploadFiles']");
            let files = inputFile[0].files;

            for(let i=0; i<files.length; i++){
                if(!checkExtension(files[i].name, files[i].size)){ return; }
                formData.append("uploadFiles", files[i]);
            }

            $.ajax({
                url: "/uploadcr/uploadAjaxAction",
                type: "post",
                data: formData,
                contentType: false,
                processData: false,
                success: function(fileList){
                    showUploadFile(fileList);
                    inputFile.val("");
                }
            });
        });
    })


</script>
<script th:inline="javascript">
    $("a#goRead").on("click", function(e){
        e.preventDefault();
        location.href = "/class/classApply?bno=" + $(this).attr("href");
    })
</script>
</body>
</html>